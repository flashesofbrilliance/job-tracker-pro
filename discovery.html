<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Discovery Engine</title>
  
  <!-- CRITICAL CSS: Inline above-the-fold styles for instant rendering -->
  <style>
    /* Critical path CSS - inline for immediate render */
    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: #1a1a2e; color: #fff; }
    .app-container { min-height: 100vh; }
    .loading-screen { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: #1a1a2e; z-index: 9999; }
    .loading-spinner { width: 50px; height: 50px; border: 3px solid #333; border-top: 3px solid #21808d; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
  
  <!-- Non-blocking CSS -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loading-screen">
    <div class="loading-spinner"></div>
  </div>

  <div class="app-container">
    <header class="app-header">
      <div class="header-content">
        <div class="header-left">
          <h1 class="app-title">üç£ Discovery Engine</h1>
        </div>
        <div class="header-actions">
          <button class="btn btn--outline btn--sm" id="refresh-btn">üîÑ Refresh</button>
          <button class="btn btn--outline btn--sm" id="open-zen-btn">üéõÔ∏è Studio</button>
          <a class="btn btn--secondary btn--sm" href="index.html">üè† Back to App</a>
        </div>
      </div>
    </header>

    <main class="sushi-discovery-main">
      <!-- Job Info Display -->
      <section class="job-info-section">
        <div class="job-display-container">
          <div class="job-card" id="job-card">
            <div class="card-primary">
              <div class="company-section">
                <h1 class="company-name" id="card-company">Loading...</h1>
                <div class="company-context">
                  <span class="sector" id="sector-value">--</span>
                  <span class="separator">‚Ä¢</span>
                  <span class="location" id="location-value">--</span>
                </div>
              </div>
              
              <div class="role-section">
                <h2 class="role-title" id="card-role">Preparing...</h2>
                <div class="salary-range" id="salary-value">$--</div>
              </div>
              
              <div class="fit-indicator">
                <div class="fit-score-container">
                  <div class="fit-score" id="fit-score-value">--</div>
                  <div class="fit-label">Match</div>
                </div>
                <div class="fit-bar">
                  <div class="fit-fill" id="fit-bar-fill"></div>
                </div>
              </div>
            </div>
            
            <div class="card-secondary">
              <div class="skills-tags" id="card-tags"></div>
              <div class="decision-helpers">
                <div class="quick-stats">
                  <div class="stat-item">
                    <span class="stat-icon">‚ö°</span>
                    <span class="stat-text" id="quick-apply">Quick Apply</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-icon">üéØ</span>
                    <span class="stat-text" id="competition-level">Medium Competition</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="action-bar">
              <button class="action-btn reject-btn" id="reject-btn">
                <span class="btn-icon">üëé</span>
                <span class="btn-text">Pass</span>
                <span class="btn-key">‚Üê</span>
              </button>
              
              <button class="action-btn next-btn" id="next-btn">
                <span class="btn-icon">‚è≠Ô∏è</span>
                <span class="btn-text">Next</span>
                <span class="btn-key">Space</span>
              </button>
              
              <button class="action-btn accept-btn" id="accept-btn">
                <span class="btn-icon">üëç</span>
                <span class="btn-text">Apply</span>
                <span class="btn-key">‚Üí</span>
              </button>
            </div>
          </div>
        </div>
      </section>
      
      <!-- Sushi Conveyor Belt -->
      <section id="sushi-conveyor-section">
        <div id="sushi-conveyor" class="sushi-conveyor">
          <div class="belt-track">
            <div class="sushi-plate" id="current-sushi">
              <div class="sushi-content">üç£</div>
            </div>
          </div>
        </div>
      </section>
      
      <!-- 3D Canvas (optional) -->
      <section class="sushi-diorama-section">
        <canvas id="sushi-3d-canvas" style="width: 100%; height: 400px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);"></canvas>
      </section>
    </main>
    
      <!-- Analytics Section -->
    <footer class="analytics-footer collapsed">
      <div class="analytics-toggle" onclick="toggleAnalytics()">
        <span>üìä Analytics</span>
      </div>
      <div class="analytics-content" id="analytics-content">
        <div class="analytics-grid">
          <div class="analytics-card">
            <h4>Learning Signals</h4>
            <div id="signals">Ready</div>
          </div>
          <div class="analytics-card">
            <h4>Belt Analytics</h4>
            <div id="belt-analytics">Active</div>
          </div>
        </div>
      </div>
    </footer>

    <div class="toast-container" id="toast-container"></div>

    <!-- Zen Studio Mixer -->
    <div class="zen-mixer" id="zen-mixer" hidden>
      <header>
        <h3>Zen Studio</h3>
        <button class="btn btn--secondary btn--sm" id="zen-toggle">Hide</button>
      </header>
      <div class="control">
        <label for="zen-glow">Zen Glow</label>
        <span id="zen-glow-value">0.15</span>
      </div>
      <input type="range" id="zen-glow" min="0" max="1" step="0.01" value="0.15" />
      <div class="control">
        <label for="wood-grain">Wood Grain</label>
        <span id="wood-grain-value">0.06</span>
      </div>
      <input type="range" id="wood-grain" min="0" max="0.5" step="0.01" value="0.06" />
      <div class="control">
        <label for="sakura">Sakura Pattern</label>
        <span id="sakura-value">0.08</span>
      </div>
      <input type="range" id="sakura" min="0" max="0.3" step="0.01" value="0.08" />
      <div class="row">
        <label>
          <input type="checkbox" id="zen-enabled" /> Enable Zen Overlays
        </label>
        <button class="btn btn--outline btn--sm" id="zen-reset">Reset</button>
      </div>
    </div>
  </div>

  <!-- SIMPLIFIED JAVASCRIPT LOADING -->
  
  <!-- Essential libraries -->
  <script src="three.min.js"></script>
  
  <!-- Error-safe initialization -->
  <script>
    // Immediate error handling and DOM safety
    window.addEventListener('error', function(e) {
      console.warn('Script error caught:', e.error?.message || e.message);
    });
    
    // Ensure all required DOM elements exist
    document.addEventListener('DOMContentLoaded', function() {
      const requiredElements = [
        'loading-screen', 'job-card', 'card-company', 'card-role', 'salary-value',
        'fit-score-value', 'sector-value', 'location-value', 'card-tags',
        'quick-apply', 'competition-level', 'reject-btn', 'next-btn', 'accept-btn',
        'sushi-conveyor', 'analytics-content', 'signals', 'belt-analytics'
      ];
      
      let missingElements = [];
      requiredElements.forEach(id => {
        if (!document.getElementById(id)) {
          missingElements.push(id);
          // Create placeholder element
          const placeholder = document.createElement('div');
          placeholder.id = id;
          placeholder.textContent = `[${id}]`;
          document.body.appendChild(placeholder);
        }
      });
      
      if (missingElements.length > 0) {
        console.warn('Created placeholder elements:', missingElements);
      }
      
      // Hide loading screen
      const loadingScreen = document.getElementById('loading-screen');
      if (loadingScreen) {
        setTimeout(() => {
          loadingScreen.style.opacity = '0';
          setTimeout(() => loadingScreen.remove(), 300);
        }, 500);
      }
      
      console.log('üç£ Emergency fix DOM ready!');
    });
    
    // Safe analytics toggle
    function toggleAnalytics() {
      const footer = document.querySelector('.analytics-footer');
      if (footer) {
        footer.classList.toggle('collapsed');
      }
    }
    
    window.toggleAnalytics = toggleAnalytics;
  </script>
  
  <!-- Load app scripts with error handling -->
  <script>
    // Load scripts safely
    function loadScript(src, callback) {
      const script = document.createElement('script');
      script.src = src;
      script.onload = callback;
      script.onerror = () => console.warn('Failed to load:', src);
      document.head.appendChild(script);
    }
    
    // Load core scripts in sequence
    setTimeout(() => {
      loadScript('performance-manager.js', () => {
        loadScript('conveyor-cache-manager.js', () => {
          loadScript('discovery.js', () => {
            console.log('üéØ All scripts loaded');
          });
        });
      });
    }, 100);
  </script>
  
  <!-- Zen Studio wiring (self-contained) -->
  <script>
    (function(){
      const defaults = { enabled: false, glow: 0.15, wood: 0.06, sakura: 0.08 };
      const storageKey = 'zenStudioSettings';

      function loadSettings(){
        try { return { ...defaults, ...(JSON.parse(localStorage.getItem(storageKey)) || {}) }; } catch { return { ...defaults }; }
      }
      function saveSettings(s){ try { localStorage.setItem(storageKey, JSON.stringify(s)); } catch {}
      }
      function $(id){ return document.getElementById(id); }

      function applySettings(s){
        const root = document.documentElement;
        root.style.setProperty('--zen-glow', String(s.glow));
        root.style.setProperty('--wood-grain-opacity', String(s.wood));
        root.style.setProperty('--sakura-opacity', String(s.sakura));

        const app = document.querySelector('.app-container');
        const conveyor = document.getElementById('sushi-conveyor-section');
        if (app) app.classList.toggle('zen-enabled', !!s.enabled);
        if (conveyor) conveyor.classList.toggle('zen-wood', !!s.enabled && s.wood > 0);

        const glowVal = $('zen-glow-value'); const woodVal = $('wood-grain-value'); const sakVal = $('sakura-value');
        if (glowVal) glowVal.textContent = s.glow.toFixed(2);
        if (woodVal) woodVal.textContent = s.wood.toFixed(2);
        if (sakVal) sakVal.textContent = s.sakura.toFixed(2);
        const enabled = $('zen-enabled'); if (enabled) enabled.checked = !!s.enabled;
        const rg = $('zen-glow'); if (rg) rg.value = String(s.glow);
        const rw = $('wood-grain'); if (rw) rw.value = String(s.wood);
        const rs = $('sakura'); if (rs) rs.value = String(s.sakura);
      }

      function init(){
        const openBtn = $('open-zen-btn');
        const panel = $('zen-mixer');
        if (!openBtn || !panel) return;
        let settings = loadSettings();
        applySettings(settings);

        openBtn.addEventListener('click', () => { panel.hidden = !panel.hidden; });
        const toggleBtn = $('zen-toggle'); if (toggleBtn) toggleBtn.addEventListener('click', () => { panel.hidden = true; });
        const enabled = $('zen-enabled'); if (enabled) enabled.addEventListener('change', e => { settings.enabled = !!e.target.checked; saveSettings(settings); applySettings(settings); });
        const rg = $('zen-glow'); if (rg) rg.addEventListener('input', e => { settings.glow = parseFloat(e.target.value || defaults.glow); saveSettings(settings); applySettings(settings); });
        const rw = $('wood-grain'); if (rw) rw.addEventListener('input', e => { settings.wood = parseFloat(e.target.value || defaults.wood); saveSettings(settings); applySettings(settings); });
        const rs = $('sakura'); if (rs) rs.addEventListener('input', e => { settings.sakura = parseFloat(e.target.value || defaults.sakura); saveSettings(settings); applySettings(settings); });
        const rst = $('zen-reset'); if (rst) rst.addEventListener('click', () => { settings = { ...defaults }; saveSettings(settings); applySettings(settings); });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else { init(); }

      // Also expose for external init if needed
      window.initZenStudio = init;
    })();
  </script>
</body>
</html>
