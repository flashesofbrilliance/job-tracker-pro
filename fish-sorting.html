<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üêü Fish Sorting Factory - Stage 1</title>
  
  <style>
    /* Industrial Fish Processing Aesthetic */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      margin: 0;
      font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
      background: linear-gradient(135deg, #0f1419 0%, #1a2332 25%, #2d3e50 50%, #1a2332 75%, #0f1419 100%);
      background-size: 400% 400%;
      animation: factoryHum 35s ease infinite;
      color: #ecf0f1;
      overflow-x: hidden;
      min-height: 100vh;
      position: relative;
    }
    
    @keyframes factoryHum {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    /* Header */
    .factory-header {
      background: linear-gradient(135deg, #1c2833 0%, #2c3e50 100%);
      padding: 20px 32px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      border-bottom: 3px solid #17a2b8;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .factory-title {
      font-size: 2rem;
      font-weight: 300;
      color: #17a2b8;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }
    
    .stage-indicator {
      background: rgba(23, 162, 184, 0.1);
      padding: 8px 16px;
      border-radius: 20px;
      border: 2px solid rgba(23, 162, 184, 0.3);
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    /* Main Factory Floor */
    .factory-floor {
      display: grid;
      grid-template-columns: 1fr 300px 1fr;
      height: 400px;
      gap: 40px;
      padding: 40px 40px 20px 40px;
      align-items: center;
    }
    
    /* Control Panels Row */
    .control-panels-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      padding: 20px 40px 40px 40px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* Conveyor Belt */
    .conveyor-section {
      background: linear-gradient(180deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
      border-radius: 15px;
      height: 500px;
      position: relative;
      overflow: hidden;
      box-shadow: 
        inset 0 0 30px rgba(0, 0, 0, 0.4),
        0 10px 40px rgba(0, 0, 0, 0.5);
      border: 4px solid #17a2b8;
    }
    
    .belt-track {
      width: 150px;
      height: 100%;
      margin: 0 auto;
      position: relative;
      background: 
        linear-gradient(90deg, #4a6174 0%, #5d6d7e 50%, #4a6174 100%),
        repeating-linear-gradient(0deg, 
          transparent 0px, 
          transparent 15px, 
          rgba(0,0,0,0.1) 15px, 
          rgba(0,0,0,0.1) 30px
        );
      animation: beltMove 4s linear infinite;
    }
    
    @keyframes beltMove {
      0% { background-position: 0px 0px, 0px 0px; }
      100% { background-position: 0px 0px, 0px 30px; }
    }
    
    /* Fish Items with Company Labels */
    .fish-item {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      cursor: grab;
      user-select: none;
      z-index: 100;
      animation: fishFlow 8s linear infinite;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    
    .fish-emoji {
      font-size: 3rem;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,0.4));
      transition: all 0.2s ease;
    }
    
    .company-label {
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
      border: 1px solid #17a2b8;
      min-width: 60px;
      text-align: center;
    }
    
    .role-label {
      background: rgba(23, 162, 184, 0.1);
      color: #17a2b8;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.65rem;
      font-weight: 500;
      max-width: 80px;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .fish-item:hover .fish-emoji {
      transform: scale(1.1);
      filter: drop-shadow(0 4px 10px rgba(0,0,0,0.6));
    }
    
    .fish-item:active {
      cursor: grabbing;
    }
    
    .fish-item.dragging {
      z-index: 1000;
      transform: translateX(-50%) rotate(10deg) scale(1.2);
      opacity: 0.9;
    }
    
    @keyframes fishFlow {
      0% { top: -12%; opacity: 0; }
      8% { opacity: 1; }
      92% { opacity: 1; }
      100% { top: 112%; opacity: 0; }
    }
    
    /* Sorting Baskets */
    .sorting-basket {
      height: 300px;
      border-radius: 20px;
      border: 4px dashed rgba(255, 255, 255, 0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: 700;
      text-align: center;
      transition: all 0.3s ease;
      background: rgba(0, 0, 0, 0.2);
      position: relative;
      backdrop-filter: blur(5px);
    }
    
    .sorting-basket.no-basket {
      color: rgba(231, 76, 60, 0.8);
      border-color: rgba(231, 76, 60, 0.6);
    }
    
    .sorting-basket.yes-basket {
      color: rgba(39, 174, 96, 0.8);
      border-color: rgba(39, 174, 96, 0.6);
    }
    
    .sorting-basket.drag-over {
      border-style: solid;
      transform: scale(1.03);
      background: rgba(255, 255, 255, 0.1);
    }
    
    .sorting-basket.no-basket.drag-over {
      background: rgba(231, 76, 60, 0.2);
      box-shadow: 0 0 40px rgba(231, 76, 60, 0.5);
      color: #e74c3c;
    }
    
    .sorting-basket.yes-basket.drag-over {
      background: rgba(39, 174, 96, 0.2);
      box-shadow: 0 0 40px rgba(39, 174, 96, 0.5);
      color: #27ae60;
    }
    
    .basket-icon {
      font-size: 4rem;
      margin-bottom: 15px;
    }
    
    .basket-label {
      font-size: 1.4rem;
      margin-bottom: 8px;
    }
    
    .basket-subtitle {
      font-size: 0.9rem;
      opacity: 0.8;
    }
    
    .basket-count {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 0.9rem;
      font-weight: 700;
      min-width: 40px;
      text-align: center;
    }
    
    /* Control Panel (Belt Speed) */
    .control-panel {
      background: rgba(28, 40, 51, 0.95);
      border-radius: 12px;
      padding: 20px;
      border: 2px solid #17a2b8;
      backdrop-filter: blur(10px);
      height: fit-content;
    }
    
    
    /* Speed Knob */
    .speed-knob-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .speed-knob {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: 
        radial-gradient(circle at 30% 30%, #5d6d7e, #34495e),
        conic-gradient(from 135deg, #2c3e50, #34495e, #2c3e50);
      border: 3px solid #17a2b8;
      position: relative;
      cursor: pointer;
      box-shadow: 
        0 4px 15px rgba(0,0,0,0.3),
        inset 0 2px 4px rgba(255,255,255,0.1);
      transition: all 0.2s ease;
    }
    
    .speed-knob:hover {
      transform: scale(1.05);
      box-shadow: 
        0 6px 20px rgba(0,0,0,0.4),
        inset 0 2px 4px rgba(255,255,255,0.15);
    }
    
    .knob-indicator {
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      width: 4px;
      height: 20px;
      background: #17a2b8;
      border-radius: 2px;
      box-shadow: 0 0 8px rgba(23, 162, 184, 0.6);
      transition: transform 0.3s ease;
    }
    
    .speed-display {
      margin-top: 8px;
      font-size: 0.8rem;
      color: #bdc3c7;
      text-align: center;
    }
    
    /* Tally Counter */
    .tally-counter {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 0.75rem;
    }
    
    .tally-item {
      display: flex;
      justify-content: space-between;
      padding: 4px 8px;
      background: rgba(52, 73, 94, 0.3);
      border-radius: 4px;
    }
    
    .tally-value {
      font-weight: 600;
      color: #17a2b8;
    }
    
    /* Upcoming Role Display */
    .upcoming-role {
      background: rgba(28, 40, 51, 0.95);
      border-radius: 12px;
      padding: 20px;
      border: 2px solid #17a2b8;
      backdrop-filter: blur(10px);
      height: fit-content;
    }
    
    
    .next-job {
      text-align: center;
      padding: 12px;
      background: rgba(52, 73, 94, 0.4);
      border-radius: 6px;
    }
    
    .next-company {
      font-weight: 600;
      color: white;
      font-size: 0.85rem;
    }
    
    .next-role {
      font-size: 0.75rem;
      color: #bdc3c7;
      margin-top: 2px;
    }
    
    .next-fish {
      font-size: 1.2rem;
      margin-top: 4px;
    }
    
    /* Metrics Panel (Hidable) */
    .metrics-panel {
      background: rgba(28, 40, 51, 0.95);
      border-radius: 12px;
      padding: 20px;
      border: 2px solid #17a2b8;
      backdrop-filter: blur(10px);
      height: fit-content;
      transition: all 0.3s ease;
    }
    
    .metrics-panel.hidden {
      opacity: 0.3;
      transform: scale(0.95);
    }
    
    .toggle-metrics {
      background: none;
      border: 1px solid #17a2b8;
      color: #17a2b8;
      padding: 2px 6px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.7rem;
      margin-left: auto;
    }
    
    .metric-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 0.75rem;
    }
    
    .metric-value {
      font-weight: 600;
      color: #e67e22;
    }
    
    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #1c2833, #2c3e50);
      color: white;
      padding: 12px 24px;
      border-radius: 6px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
      animation: slideInFromTop 0.4s ease-out;
      z-index: 1000;
      font-size: 0.9rem;
      border: 1px solid #17a2b8;
    }
    
    @keyframes slideInFromTop {
      from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    
    /* Loading */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 500;
    }
    
    .loading-content {
      text-align: center;
      color: white;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #17a2b8;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Panel Titles */
    .panel-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 15px;
      color: #17a2b8;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .factory-floor {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr auto 1fr;
        gap: 20px;
        padding: 20px;
        height: 300px;
      }
      
      .conveyor-section {
        order: 2;
        height: 250px;
      }
      
      .sorting-basket {
        height: 150px;
      }
      
      .control-panels-row {
        grid-template-columns: 1fr;
        gap: 15px;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="factory-header">
    <h1 class="factory-title">üêü Fish Sorting Factory</h1>
    <div class="stage-indicator">STAGE 1 - Raw Processing</div>
  </header>

  <!-- Main Factory Floor -->
  <div class="factory-floor">
    <!-- NO Basket (Left) -->
    <div class="sorting-basket no-basket" id="no-basket">
      <div class="basket-icon">‚ùå</div>
      <div class="basket-label">NO</div>
      <div class="basket-subtitle">Not interested</div>
      <div class="basket-count" id="no-count">0</div>
    </div>

    <!-- Conveyor Belt (Center) -->
    <div class="conveyor-section">
      <div class="belt-track" id="belt-track">
        <!-- Fish items spawn here -->
      </div>
    </div>

    <!-- YES Basket (Right) -->
    <div class="sorting-basket yes-basket" id="yes-basket">
      <div class="basket-icon">‚úÖ</div>
      <div class="basket-label">YES</div>
      <div class="basket-subtitle">Interested</div>
      <div class="basket-count" id="yes-count">0</div>
    </div>
  </div>

  <!-- Control Panels Row -->
  <div class="control-panels-row">
    <!-- Metrics Panel -->
    <div class="metrics-panel" id="metrics-panel">
      <div class="panel-title">
        <span>üìä</span>
        <span>Metrics</span>
        <button class="toggle-metrics" onclick="toggleMetrics()">Hide</button>
      </div>
      
      <div class="metric-row">
        <span>Speed:</span>
        <span class="metric-value" id="sorting-speed">0/min</span>
      </div>
      <div class="metric-row">
        <span>Accuracy:</span>
        <span class="metric-value" id="accuracy-rate">--</span>
      </div>
      <div class="metric-row">
        <span>Accept Rate:</span>
        <span class="metric-value" id="accept-rate">--</span>
      </div>
      <div class="metric-row">
        <span>Efficiency:</span>
        <span class="metric-value" id="efficiency-rate">--</span>
      </div>
    </div>

    <!-- Belt Speed Control Panel -->
    <div class="control-panel">
      <div class="panel-title">
        <span>‚ö°</span>
        <span>Belt Speed</span>
      </div>
      
      <div class="speed-knob-container">
        <div class="speed-knob" id="speed-knob">
          <div class="knob-indicator" id="knob-indicator"></div>
        </div>
        <div class="speed-display" id="speed-display">Normal</div>
      </div>
      
      <div class="tally-counter">
        <div class="tally-item">
          <span>Processed:</span>
          <span class="tally-value" id="tally-processed">0</span>
        </div>
        <div class="tally-item">
          <span>Accepted:</span>
          <span class="tally-value" id="tally-accepted">0</span>
        </div>
        <div class="tally-item">
          <span>Rejected:</span>
          <span class="tally-value" id="tally-rejected">0</span>
        </div>
        <div class="tally-item">
          <span>Neglected:</span>
          <span class="tally-value" id="tally-neglected">0</span>
        </div>
      </div>
    </div>

    <!-- Next Up Panel -->
    <div class="upcoming-role">
      <div class="panel-title">
        <span>üîú</span>
        <span>Next Up</span>
      </div>
      
      <div class="next-job">
        <div class="next-company" id="next-company">Loading...</div>
        <div class="next-role" id="next-role">--</div>
        <div class="next-fish" id="next-fish">üêü</div>
      </div>
    </div>
  </div>


  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div>Loading fresh fish from the dock...</div>
    </div>
  </div>

  <script>
    // Core Data Management
    let jobsData = [];
    let currentJobIndex = 0;
    let processingStats = {
      processed: 0,
      accepted: 0,
      rejected: 0,
      neglected: 0,
      startTime: Date.now()
    };
    
    // Fish-to-sector mapping
    const fishMap = {
      'Tech': 'üêü',
      'Healthcare': 'üê°',
      'Education': 'üê†', 
      'Finance': 'ü¶à',
      'Marketing': 'üêô',
      'Sales': 'ü¶ë',
      'default': 'üêü'
    };
    
    // Speed control
    let beltSpeed = 1;
    let spawnInterval = null;
    let metricsHidden = false;
    
    // Initialize factory
    async function initFishSortingFactory() {
      console.log('üêü Initializing Fish Sorting Factory...');
      
      await loadJobs();
      setupDragAndDrop();
      setupSpeedKnob();
      startFishSpawning();
      startMetricsUpdater();
      hideLoadingOverlay();
      
      console.log('‚úÖ Fish Sorting Factory Ready!');
    }

    // Load job data
    async function loadJobs() {
      try {
        const response = await fetch('/api/job-recommendations');
        const data = await response.json();
        jobsData = data.jobs || [];
        
        if (jobsData.length === 0) {
          showToast('‚ùå No fish available for sorting');
          return;
        }
        
        updateUpcomingRole();
        showToast(`üêü Loaded ${jobsData.length} fresh fish for sorting`);
        
      } catch (error) {
        console.error('Failed to load jobs:', error);
        showToast('‚ùå Failed to load fish from dock');
      }
    }

    // Hide loading
    function hideLoadingOverlay() {
      document.getElementById('loading-overlay').style.display = 'none';
    }

    // Spawn fish items
    function spawnFishItem() {
      if (currentJobIndex >= jobsData.length) {
        showToast('üéâ All fish sorted! New catch arriving...');
        setTimeout(resetSession, 2000);
        return;
      }
      
      const job = jobsData[currentJobIndex];
      const fishEmoji = fishMap[job.sector] || fishMap.default;
      
      const fishItem = document.createElement('div');
      fishItem.className = 'fish-item';
      fishItem.draggable = true;
      fishItem.dataset.jobIndex = currentJobIndex;
      
      fishItem.innerHTML = `
        <div class="company-label">${job.company}</div>
        <div class="fish-emoji">${fishEmoji}</div>
        <div class="role-label">${job.roleTitle}</div>
      `;
      
      // Random positioning
      const offset = (Math.random() - 0.5) * 20;
      fishItem.style.left = `calc(50% + ${offset}px)`;
      fishItem.style.animationDelay = `${Math.random() * 1}s`;
      fishItem.style.animationDuration = `${8 / beltSpeed}s`;
      
      document.getElementById('belt-track').appendChild(fishItem);
      setupFishDragEvents(fishItem);
      
      // Auto-remove (neglected)
      setTimeout(() => {
        if (fishItem.parentNode) {
          fishItem.remove();
          if (parseInt(fishItem.dataset.jobIndex) === currentJobIndex) {
            handleFishDecision('neglected');
          }
        }
      }, (8000 / beltSpeed) + 1000);
      
      currentJobIndex++;
      updateUpcomingRole();
    }

    // Setup fish drag events
    function setupFishDragEvents(fishItem) {
      fishItem.addEventListener('dragstart', (e) => {
        fishItem.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', fishItem.dataset.jobIndex);
      });

      fishItem.addEventListener('dragend', (e) => {
        fishItem.classList.remove('dragging');
      });
    }

    // Setup drag and drop
    function setupDragAndDrop() {
      const baskets = document.querySelectorAll('.sorting-basket');
      baskets.forEach(basket => setupDropZone(basket));
    }

    function setupDropZone(dropZone) {
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
      });

      dropZone.addEventListener('dragleave', (e) => {
        dropZone.classList.remove('drag-over');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        
        const jobIndex = parseInt(e.dataTransfer.getData('text/plain'));
        const fishItem = document.querySelector(`[data-job-index="${jobIndex}"]`);
        
        if (fishItem) {
          fishItem.remove();
          const decision = dropZone.id === 'yes-basket' ? 'accepted' : 'rejected';
          handleFishDecision(decision);
        }
      });
    }

    // Handle fish decisions
    function handleFishDecision(decision) {
      const job = jobsData[currentJobIndex - 1];
      if (!job) return;
      
      processingStats.processed++;
      processingStats[decision]++;
      
      const messages = {
        accepted: `‚úÖ Accepted: ${job.company}`,
        rejected: `‚ùå Rejected: ${job.company}`,
        neglected: `‚è∞ Neglected: ${job.company} (fell off belt)`
      };
      
      showToast(messages[decision]);
      updateTallyDisplay();
      updateBasketCounts();
    }

    // Update tally display
    function updateTallyDisplay() {
      document.getElementById('tally-processed').textContent = processingStats.processed;
      document.getElementById('tally-accepted').textContent = processingStats.accepted;
      document.getElementById('tally-rejected').textContent = processingStats.rejected;
      document.getElementById('tally-neglected').textContent = processingStats.neglected;
    }

    // Update basket counts
    function updateBasketCounts() {
      document.getElementById('yes-count').textContent = processingStats.accepted;
      document.getElementById('no-count').textContent = processingStats.rejected;
    }

    // Update upcoming role
    function updateUpcomingRole() {
      const nextJob = jobsData[currentJobIndex];
      if (nextJob) {
        document.getElementById('next-company').textContent = nextJob.company;
        document.getElementById('next-role').textContent = nextJob.roleTitle;
        document.getElementById('next-fish').textContent = fishMap[nextJob.sector] || fishMap.default;
      } else {
        document.getElementById('next-company').textContent = 'No more fish';
        document.getElementById('next-role').textContent = 'End of batch';
        document.getElementById('next-fish').textContent = 'üèÅ';
      }
    }

    // Setup speed knob
    function setupSpeedKnob() {
      const knob = document.getElementById('speed-knob');
      const indicator = document.getElementById('knob-indicator');
      const display = document.getElementById('speed-display');
      
      let isDragging = false;
      let startAngle = 0;
      let currentRotation = 0;
      
      knob.addEventListener('mousedown', startDrag);
      knob.addEventListener('touchstart', startDrag);
      
      function startDrag(e) {
        isDragging = true;
        const rect = knob.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;
        startAngle = Math.atan2(clientY - centerY, clientX - centerX);
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchmove', drag);
        document.addEventListener('touchend', stopDrag);
      }
      
      function drag(e) {
        if (!isDragging) return;
        
        const rect = knob.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;
        const currentAngle = Math.atan2(clientY - centerY, clientX - centerX);
        
        let deltaAngle = currentAngle - startAngle;
        currentRotation += deltaAngle * (180 / Math.PI);
        
        // Constrain rotation
        currentRotation = Math.max(-135, Math.min(135, currentRotation));
        
        // Update speed based on rotation
        beltSpeed = 0.5 + ((currentRotation + 135) / 270) * 2.5; // 0.5 to 3.0
        
        indicator.style.transform = `translateX(-50%) rotate(${currentRotation}deg)`;
        
        const speedLabels = ['Slow', 'Normal', 'Fast', 'Faster', 'Very Fast', 'Maximum'];
        const speedIndex = Math.floor(((beltSpeed - 0.5) / 2.5) * speedLabels.length);
        display.textContent = speedLabels[Math.min(speedIndex, speedLabels.length - 1)];
        
        // Update belt animation
        const beltTrack = document.getElementById('belt-track');
        beltTrack.style.animationDuration = `${4 / beltSpeed}s`;
        
        // Restart spawning
        clearInterval(spawnInterval);
        startFishSpawning();
        
        startAngle = currentAngle;
      }
      
      function stopDrag() {
        isDragging = false;
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchmove', drag);
        document.removeEventListener('touchend', stopDrag);
      }
    }

    // Start fish spawning
    function startFishSpawning() {
      const spawnDelay = 3000 / beltSpeed;
      
      spawnInterval = setInterval(() => {
        if (currentJobIndex < jobsData.length) {
          spawnFishItem();
        }
      }, spawnDelay);
    }

    // Start metrics updater
    function startMetricsUpdater() {
      setInterval(() => {
        updatePerformanceMetrics();
      }, 1000);
    }

    // Update performance metrics
    function updatePerformanceMetrics() {
      const elapsed = (Date.now() - processingStats.startTime) / 1000 / 60;
      const sortingSpeed = Math.round(processingStats.processed / Math.max(elapsed, 0.1));
      
      const accuracyRate = processingStats.processed > 0 ? 
        Math.round(((processingStats.accepted + processingStats.rejected) / processingStats.processed) * 100) : 0;
      
      const acceptRate = processingStats.processed > 0 ? 
        Math.round((processingStats.accepted / processingStats.processed) * 100) : 0;
      
      const efficiencyRate = processingStats.processed > 0 ?
        Math.round((1 - (processingStats.neglected / processingStats.processed)) * 100) : 0;
      
      document.getElementById('sorting-speed').textContent = `${sortingSpeed}/min`;
      document.getElementById('accuracy-rate').textContent = `${accuracyRate}%`;
      document.getElementById('accept-rate').textContent = `${acceptRate}%`;
      document.getElementById('efficiency-rate').textContent = `${efficiencyRate}%`;
    }

    // Toggle metrics panel
    function toggleMetrics() {
      const panel = document.getElementById('metrics-panel');
      const button = document.querySelector('.toggle-metrics');
      
      metricsHidden = !metricsHidden;
      
      if (metricsHidden) {
        panel.classList.add('hidden');
        button.textContent = 'Show';
      } else {
        panel.classList.remove('hidden');
        button.textContent = 'Hide';
      }
    }

    // Show toast
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Reset session
    function resetSession() {
      currentJobIndex = 0;
      processingStats = {
        processed: 0,
        accepted: 0,
        rejected: 0,
        neglected: 0,
        startTime: Date.now()
      };
      
      document.querySelectorAll('.fish-item').forEach(item => item.remove());
      updateTallyDisplay();
      updateBasketCounts();
      updateUpcomingRole();
      showToast('üîÑ New batch of fish arrived!');
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      switch(e.key) {
        case 'r':
        case 'R':
          e.preventDefault();
          resetSession();
          break;
        case 'h':
        case 'H':
          e.preventDefault();
          toggleMetrics();
          break;
      }
    });

    // Initialize on load
    document.addEventListener('DOMContentLoaded', initFishSortingFactory);
  </script>
</body>
</html>